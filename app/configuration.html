<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Kyte - Shipyard</title>
    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.23/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/assets/css/kyte-form.css">
    <link rel="stylesheet" href="/assets/css/kyte-shipyard-common.css">
    <!--  -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Nunito:wght@200;500;700&display=swap" rel="stylesheet">
    <!-- javascripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.23/js/jquery.dataTables.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js" integrity="sha256-hlKLmzaRlE8SCJC1Kw8zoUbU8BxA+8kR3gseuKfMjxA=" crossorigin="anonymous"></script>
    <!-- JavaScript obfuscator -->
    <script src="https://cdn.jsdelivr.net/npm/javascript-obfuscator/dist/index.browser.js"></script>
    <!-- Kyte -->
    <script src="https://cdn.keyqcloud.com/kyte/js/stable/kyte.js" crossorigin="anonymous"></script>
    <script>
        // Auto-detect localhost and load non-obfuscated source files for development
        (function() {
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const jsPath = isLocalhost ? '/assets/js/source/' : '/assets/js/';

            const scripts = [
                'kyte-shipyard.js',
                'navigation.js',
                'kyte-shipyard-tables.js',
                'kyte-shipyard-application-configuration.js'
            ];

            scripts.forEach(function(script) {
                document.write('<script src="' + jsPath + script + '"><\/script>');
            });

            if (isLocalhost) {
                console.log('%c[DEV MODE] Loading non-obfuscated source files from ' + jsPath, 'color: #4CAF50; font-weight: bold;');
            }
        })();
    </script>

</head>

<body>
    <!-- Page loading modal -->
    <div id="pageLoaderModal" class="modal white" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-sm h-100 d-flex">
            <div class="mx-auto align-self-center" style="width: 48px">
                <div class="spinner-wrapper text-center fa-6x"><span class="fas fa-sync fa-spin"></span></div>
            </div>
        </div>
    </div>

    <div id="wrapper">
        <!-- START UNIFIED TOP NAV -->
        <nav id="application-nav" class="navbar navbar-dark navbar-expand-sm">
            <div class="container-fluid">
                <!-- Sidebar Toggle (Mobile) -->
                <button id="sidebar-toggle" aria-label="Toggle sidebar">
                    <i class="fas fa-bars"></i>
                </button>

                <!-- Brand -->
                <a href="/app/" class="navbar-brand">
                    Kyte Shipyard<sup>™</sup>
                    <img src="/assets/images/kyte_shipyard_light.png" alt="Kyte Shipyard">
                </a>

                <!-- Center: App Selector (clickable to dashboard) -->
                <a href="#" id="app-selector" class="mx-auto">
                    <i class="fas fa-rocket"></i>
                    <span id="app-name">Application Dashboard</span>
                </a>

                <!-- Right: Account Dropdown -->
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-2"></i>Account
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownMenuLink">
                            <li><a class="dropdown-item" href="/app/settings.html"><i class="fas fa-cog me-2"></i>Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item logout" href="#"><i class="fas fa-power-off me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
        <!-- END UNIFIED TOP NAV -->

        <!-- Page Container with Sidebar -->
        <div id="page-container">
            <!-- Application Sidebar -->
            <aside id="app-sidebar">
                <!-- Sidebar content will be populated by JavaScript -->
            </aside>

            <!-- Sidebar Overlay for Mobile -->
            <div id="sidebar-overlay"></div>

            <!-- Main Content -->
            <main id="app-config-page-wrapper">
            <!-- BEGIN SIDE NAVIGATION -->
            <div id="sidenav" class="d-flex flex-column flex-shrink-0">
                <div class="sidebar-header">
                    <a href="#" id="back-to-app" class="sidebar-back-button mb-3">
                        <i class="fas fa-arrow-left"></i>
                        <span>Back to Application</span>
                    </a>
                    <h3 id="app-name" class="mb-2">Application Configuration</h3>
                    <div class="app-subtitle">Manage your application settings</div>
                </div>
                
                <div class="sidebar-nav">
                    <div class="nav-section">
                        <div class="nav-section-title">Configuration</div>
                        <button class="nav-link active" data-section="App">
                            <i class="fas fa-cog"></i>
                            App Settings
                        </button>
                        <button class="nav-link" data-section="EnvironmentVars">
                            <i class="fas fa-code"></i>
                            Environment Variables
                        </button>
                        <button class="nav-link" data-section="KyteConnect">
                            <i class="fas fa-rocket"></i>
                            Kyte Connect
                        </button>
                    </div>
                </div>
            </div>
            <!-- END SIDE NAVIGATION -->

            <div class="main-content">
                <!-- App Configuration Section -->
                <div id="App" class="content-section active">
                    <!-- User Table Configuration -->
                    <div class="config-card">
                        <div class="config-card-header">
                            <div class="config-card-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div>
                                <h3 class="config-card-title">User Table Configuration</h3>
                            </div>
                        </div>
                        <p class="config-card-description">
                            Customize the user table for your web app. Specify the fields and attributes that define your users, such as name, email, and password. This allows you to tailor the user management system to fit your specific requirements.
                        </p>
                        <div class="form-grid-3">
                            <div class="form-group">
                                <label class="form-label">User Model</label>
                                <select id="user_model" class="form-select">
                                    <option value="0">Kyte Framework User (Default)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Login Username Field</label>
                                <select id="username_colname" class="form-select" disabled>
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Login Password Field</label>
                                <select id="password_colname" class="form-select" disabled>
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Organization Table Configuration -->
                    <div class="config-card">
                        <div class="config-card-header">
                            <div class="config-card-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <div>
                                <h3 class="config-card-title">Organization Table Configuration</h3>
                            </div>
                        </div>
                        <p class="config-card-description">
                            Set up an organization table to manage users within specific groups or organizations. Define fields like organization name, description, and membership attributes to organize users and facilitate collaboration within your web app.
                        </p>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Organization Model</label>
                                <select id="org_model" class="form-select" disabled>
                                    <option value="0" id="default_org_model">Kyte Framework Account (Default)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">User Foreign Key to Organization</label>
                                <select id="userorg_colname" class="form-select" disabled>
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- AWS Credentials -->
                    <div class="config-card">
                        <div class="config-card-header">
                            <div class="config-card-icon">
                                <i class="fab fa-aws"></i>
                            </div>
                            <div>
                                <h3 class="config-card-title">AWS Credentials</h3>
                            </div>
                        </div>
                        <p class="config-card-description">
                            AWS credentials configured for this application. These credentials are used for accessing AWS services required by your application.
                        </p>
                        <div class="aws-credentials-grid">
                            <div class="aws-field">
                                <label class="form-label">Username</label>
                                <input type="text" id="aws_username" class="form-control" readonly>
                            </div>
                            <div class="aws-field">
                                <label class="form-label">Public Key</label>
                                <input type="text" id="aws_public_key" class="form-control" readonly>
                            </div>
                            <div class="aws-field">
                                <label class="form-label">Secret Key</label>
                                <div class="aws-secret-notice">
                                    <i class="fas fa-eye-slash"></i>
                                    <span>Secret key is not displayed for security</span>
                                </div>
                            </div>
                        </div>
                        <div class="security-notice">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>Note:</strong> Currently, changing AWS credentials for your application is not supported. If you need to change AWS credentials, please contact support.
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="d-flex justify-content-end pb-3 pe-3">
                        <button id="saveAppSettings" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Save App Configuration
                        </button>
                    </div>
                </div>

                <!-- Environment Variables Section -->
                <div id="EnvironmentVars" class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">Environment Variables</h2>
                        <button class="btn-new" id="newEnvVar">
                            <i class="fas fa-plus"></i>
                            Add Variable
                        </button>
                    </div>
                    <div class="section-content">
                        <div class="mb-4">
                            <p class="text-muted">
                                Manage your application's environment variables here. Add new variables, edit existing ones, or remove them as needed. 
                                Ensure to follow the correct format and understand the impact of changes on your application's behavior.
                            </p>
                        </div>
                        <table id="tblEnvVars" class="table table-striped w-100"></table>
                    </div>
                </div>

                <!-- Kyte Connect Section -->
                <div id="KyteConnect" class="content-section">
                    <!-- Obfuscation Settings -->
                    <div class="config-card">
                        <div class="config-card-header">
                            <div class="config-card-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div>
                                <h3 class="config-card-title">Kyte Connect Obfuscation</h3>
                            </div>
                        </div>
                        <p class="config-card-description">
                            Control whether JavaScript for connecting to the Kyte API endpoint is obfuscated. Obfuscation is recommended for security, but if organizational policies (such as firewall requirements) prevent obfuscated code, you can disable it here.
                            <br><br>
                            <strong>Important:</strong> Changing this setting will automatically regenerate the Kyte Connect code and update all published pages with the new version. You can review the updated code in the "Kyte Connect Code Comparison" section below before it's applied.
                        </p>
                        <div class="form-group">
                            <label class="form-label">Obfuscation Setting</label>
                            <select id="obfuscate_kyte_connect" class="form-select">
                                <option value="1">Obfuscate (Recommended)</option>
                                <option value="0">Do Not Obfuscate (Not Recommended)</option>
                            </select>
                        </div>
                        <!-- Save Button -->
                        <div class="d-flex justify-content-end">
                            <button id="saveObfuscationSettings" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                Save Obfuscation Settings
                            </button>
                        </div>
                    </div>

                    <!-- Kyte Connect Configuration -->
                    <div class="config-card">
                        <div class="config-card-header">
                            <div class="config-card-icon">
                                <i class="fas fa-rocket"></i>
                            </div>
                            <div>
                                <h3 class="config-card-title">Kyte Connect Code Comparison</h3>
                            </div>
                        </div>
                        <p class="config-card-description">
                            Compare your current Kyte Connect JavaScript with the latest system version. Update your application to use the latest code when API endpoints or configurations change.
                        </p>
                        
                        <!-- Version Status Banner -->
                        <div id="version-status-banner" class="version-status-banner">
                            <div class="status-indicator">
                                <i class="fas fa-sync-alt status-icon"></i>
                                <span class="status-text">Checking versions...</span>
                            </div>
                        </div>

                        <!-- Code Comparison Container -->
                        <div class="code-comparison-container">
                            <!-- Current Version -->
                            <div class="code-panel current-version">
                                <div class="code-panel-header">
                                    <h4 class="code-panel-title">
                                        <i class="fas fa-file-code me-2"></i>
                                        Current Application Version
                                    </h4>
                                    <div class="code-panel-info">
                                        <span class="version-badge current">
                                            <i class="fas fa-clock me-1"></i>
                                            <span id="current-version-date">Loading...</span>
                                        </span>
                                    </div>
                                </div>
                                <div class="code-panel-content">
                                    <div class="code-wrapper">
                                        <pre id="current-kyte-code" class="code-block"><code>Loading current version...</code></pre>
                                    </div>
                                </div>
                            </div>

                            <!-- System Version -->
                            <div class="code-panel system-version">
                                <div class="code-panel-header">
                                    <h4 class="code-panel-title">
                                        <i class="fas fa-cloud me-2"></i>
                                        Latest System Version
                                    </h4>
                                    <div class="code-panel-info">
                                        <span class="version-badge system">
                                            <i class="fas fa-rocket me-1"></i>
                                            <span id="system-version-date">Loading...</span>
                                        </span>
                                    </div>
                                </div>
                                <div class="code-panel-content">
                                    <div class="code-wrapper">
                                        <pre id="system-kyte-code" class="code-block"><code>Loading system version...</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="code-actions">
                            <button id="refresh-comparison" class="btn btn-secondary">
                                <i class="fas fa-sync-alt me-2"></i>
                                Refresh Comparison
                            </button>
                            <button id="update-to-system" class="btn btn-primary" disabled>
                                <i class="fas fa-upload me-2"></i>
                                Update to System Version
                            </button>
                            <button id="view-diff" class="btn btn-outline-info">
                                <i class="fas fa-search me-2"></i>
                                View Detailed Diff
                            </button>
                        </div>

                        <!-- Diff Modal Trigger (Hidden, will be shown when differences exist) -->
                        <div id="diff-summary" class="diff-summary" style="display: none;">
                            <div class="diff-stats">
                                <span class="diff-stat additions">
                                    <i class="fas fa-plus-circle"></i>
                                    <span id="additions-count">0</span> additions
                                </span>
                                <span class="diff-stat deletions">
                                    <i class="fas fa-minus-circle"></i>
                                    <span id="deletions-count">0</span> deletions
                                </span>
                                <span class="diff-stat modifications">
                                    <i class="fas fa-edit"></i>
                                    <span id="modifications-count">0</span> changes
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </main>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content d-flex justify-content-between align-items-center">
            <div class="footer-versions">
                <div>Kyte Shipyard™ Version <span id="kyteShipyardVersion"></span></div>
                <div>Kyte JS Version <span id="kyteJSVersion"></span></div>
            </div>
            <p class="footer-copyright mb-0">KeyQ © 2020-2026</p>
        </div>
    </footer>

    <!-- modal form -->
    <div id="modalForm"></div>

    <script>
        // Navigation handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Get the application ID from localStorage (set by kyte-shipyard-application-configuration.js)
            function getDashboardUrl() {
                const appId = localStorage.getItem('currentAppId');
                if (appId) {
                    const dashboardRequest = btoa(JSON.stringify({'model': 'Application', 'idx': parseInt(appId)}));
                    return '/app/dashboard/?request=' + encodeURIComponent(dashboardRequest);
                }
                return '/app/';
            }

            // Back button handler (goes to dashboard)
            const backBtn = document.getElementById('back-to-app');
            if (backBtn) {
                backBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = getDashboardUrl();
                });
            }

            // App selector (dashboard link)
            const appSelector = document.getElementById('app-selector');
            if (appSelector) {
                appSelector.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = getDashboardUrl();
                });
            }
        });
    </script>
</body>
</html>